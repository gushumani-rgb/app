<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Work From Anywhere</title>
  <meta name="description" content="Explore tips, guides, and insights on how to work from anywhere in the world. Stay productive, travel freely, and optimize your remote lifestyle." />

  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; background: #fff; color: #111; }
    header { text-align: center; margin-bottom: 30px; }
    article { margin-bottom: 40px; border-bottom: 1px solid #ccc; padding-bottom: 20px; }
    h1 { margin-top: 0; }
    h2 { margin-bottom: 5px; }
    .snippet { color: #555; }
    .featured-image { max-width: 100%; height: auto; margin-bottom: 10px; border-radius: 5px; }
    .meta { font-size: 0.9em; color: #444; margin-bottom: 10px; font-weight: 500; }
    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>Work From Anywhere</h1>
  </header>

  <main id="posts" aria-live="polite">
    Loading posts...
  </main>

  <!-- Script to load posts dynamically -->
  <script>
    async function loadPosts() {
      const container = document.getElementById("posts");

      try {
        const res = await fetch('index.json');
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);

        const posts = await res.json();

        if (!posts || posts.length === 0) {
          container.innerHTML = "<p>No posts are available at the moment. Please check back later.</p>";
          return;
        }

        // Sort posts by date descending (newest first)
        posts.sort((a, b) => {
          const dateA = a.date ? new Date(a.date) : new Date(0);
          const dateB = b.date ? new Date(b.date) : new Date(0);
          return dateB - dateA;
        });

        container.innerHTML = "";

        posts.forEach(post => {
          const article = document.createElement("article");
          article.setAttribute("role", "article");

          const postDate = post.date ? new Date(post.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) : '';
          const author = post.author || "Unknown";
          const image = post.featuredImage ? `<img src="${post.featuredImage}" alt="${post.title}" class="featured-image">` : "";

          // Truncate summary to 150 characters
          const maxLength = 150;
          let summary = post.summary || "";
          let readMore = "";

          if (summary.length > maxLength) {
            // Truncate at the nearest word
            summary = summary.substring(0, maxLength);
            summary = summary.substring(0, summary.lastIndexOf(' ')) + "...";
            readMore = ` <a href="${post.link}" target="_blank" rel="noopener noreferrer">Read more</a>`;
          }

          article.innerHTML = `
            ${image}
            <h2><a href="${post.link}" target="_blank" rel="noopener noreferrer">${post.title}</a></h2>
            <div class="meta">By ${author} | ${postDate}</div>
            <p class="snippet">${summary}${readMore}</p>
          `;

          container.appendChild(article);
        });

      } catch (err) {
        console.error('Error loading posts:', err);
        container.innerHTML = "<p>Unable to load posts at this time. Please try again later.</p>";
      }
    }

    loadPosts();
  </script>

  <!-- Firebase & Web Push Notifications -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBk9CnCJlTnSkvdC2PNB6UYiV0BnAkO088",
      authDomain: "work-from-anywhere-ac57b.firebaseapp.com",
      projectId: "work-from-anywhere-ac57b",
      storageBucket: "work-from-anywhere-ac57b.firebasestorage.app",
      messagingSenderId: "1058696678009",
      appId: "1:1058696678009:web:a408c66c367439a22b22a8",
      measurementId: "G-KJ1LHJWTZX"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // Request notification permission
    function requestNotificationPermission() {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          messaging.getToken({
            vapidKey: 'BDJXLByXJrQ8SbjR1D9TdXkC2FgobKde9J4HcpWpKTWGtul01NFSSwFkMESgpuj_6mneMUioheGNFajKWdYcK6Q'
          }).then(token => {
            fetch(`https://iid.googleapis.com/iid/v1/${token}/rel/topics/all`, {
              method: 'POST',
              headers: { 'Authorization': 'key=m8CiUozg6owbUTM0E2cdpYGU4xr_EpoSeewTjaqx5f0' }
            }).then(res => console.log(res.ok ? 'Subscribed to topic "all"' : 'Failed to subscribe'))
              .catch(console.error);
          }).catch(console.error);
        } else {
          console.log('Notifications denied');
        }
      });
    }

    if (Notification.permission === 'default') requestNotificationPermission();

    // Handle foreground messages
    messaging.onMessage(payload => {
      if (Notification.permission === 'granted') {
        const { title, body, icon, click_action } = payload.notification;
        const notification = new Notification(title, { body, icon });
        notification.onclick = e => { 
          e.preventDefault(); 
          window.open(click_action, '_blank'); 
          notification.close(); 
        };
      }
    });

    // Register service worker for background notifications
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('firebase-messaging-sw.js', { scope: './' })
        .then(reg => messaging.useServiceWorker(reg))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
