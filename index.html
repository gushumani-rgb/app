<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anywhere Income – Work from Anywhere & Earn Online in 2025</title>
<meta name="description" content="Anywhere Income 2025: Discover remote jobs, online earning tips, and guides to make money from home effortlessly.">
<link rel="manifest" href="/manifest.json">
<link rel="alternate" type="application/json" href="/index.json">
<style>
  body {margin:0;font-family:Arial,sans-serif;background:#f7f8fb;color:#4a5568;}
  .wrap {max-width:800px;margin:36px auto;padding:20px;}
  h1 {text-align:center;color:#0b63b8;margin-bottom:24px;}
  .search {width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefb;margin-bottom:12px;}
  .post {background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 6px 18px rgba(11,63,120,0.06);}
  .post h2 {margin:0 0 6px;font-size:16px;}
  .post img {width:100%;height:auto;aspect-ratio:5/2;min-height:160px;border-radius:8px;margin-bottom:8px;display:block;object-fit:cover;}
  .post-text {font-size:14px;margin-bottom:8px;min-height:80px;}
  .read-more {display:inline-block;margin-top:6px;color:#0b63b8;font-size:14px;text-decoration:none;}
  .date {font-size:12px;color:#1f2937;margin-top:8px;}
  .post-skeleton {background:#eceff6;border-radius:12px;height:200px;margin-bottom:14px;animation:pulse 1.2s infinite;}
  @keyframes pulse {0% {opacity:1;}50% {opacity:0.4;}100% {opacity:1;}}
  #posts {min-height:500px;}
</style>
</head>
<body>
<header class="wrap" role="banner" aria-label="Site header">
  <h1 id="site-title">Anywhere Income</h1>
</header>

<main id="maincontent" role="main" tabindex="-1">
  <div class="wrap">
    <input id="jsonFilter" class="search" placeholder="Filter posts...">
    <div id="posts">
      <div class="post-skeleton"></div>
      <div class="post-skeleton"></div>
      <div class="post-skeleton"></div>
    </div>
  </div>
</main>

<footer class="wrap" role="contentinfo" aria-label="Site footer" style="text-align:center;padding:12px;color:#4a5568;">
  <small>&copy; <span id="year"></span> Anywhere Income</small>
</footer>

<script>
document.getElementById('year').textContent = new Date().getFullYear();

// --- Helpers ---
function fixPath(path,type='post'){ if(!path) return ''; if(path.startsWith('http')||path.startsWith('/')) return path; return type==='image'?'Images/'+path:'Posts/'+path; }
function timeAgo(dateStr){ const d=new Date(dateStr), now=new Date(), diff=Math.floor((now-d)/1000); if(diff<60) return diff+' second'+(diff!==1?'s':'')+' ago'; if(diff<3600) return Math.floor(diff/60)+' minute'+(Math.floor(diff/60)!==1?'s':'')+' ago'; if(diff<86400) return Math.floor(diff/3600)+' hour'+(Math.floor(diff/3600)!==1?'s':'')+' ago'; return Math.floor(diff/86400)+' day'+(Math.floor(diff/86400)!==1?'s':'')+' ago'; }
function handleImageError(img){ img.onerror=null; img.src='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="500" height="200"><rect width="100%" height="100%" fill="#eceff6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9aa3b2" font-size="14">no image</text></svg>'); img.alt='no image'; }
function getYouTubeId(link){ if(!link) return null; try { let match = link.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/); if(match) return match[1]; match = link.match(/youtu\.be\/([a-zA-Z0-9_-]+)/); if(match) return match[1]; if(link.includes('youtube.com/watch')){ const urlParams = new URLSearchParams(link.split('?')[1] || ''); return urlParams.get('v'); } return null; } catch(e){ return null; } }
function makeLink(href,title){ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=title; return a; }
function normalizePath(path) { if (!path) return '/'; if (!path.startsWith('/')) path = '/' + path; if (path !== '/' && path.endsWith('/')) path = path.slice(0, -1); if (path.endsWith('/index.html')) path = path.slice(0, -10); return path; }

// --- Load posts ---
async function loadPosts(){ 
  try{ const res=await fetch('index.json',{cache:'no-cache'}); if(!res.ok) throw new Error('Failed to fetch index.json'); const data=await res.json(); return Array.isArray(data)?data:[]; } catch(e){ console.warn('Error loading posts:',e); return []; } 
}

// --- SPA modal management with cache ---
let openPost = null;
let modalContentCache = {}; // cache post content

function getPostByPath(path, posts) { 
  const current = normalizePath(path); 
  return posts.find(p => normalizePath(p.link || '/') === current); 
}

async function showPostModal(post) {
  openPost = post;
  document.getElementById('posts').style.display = 'none';
  
  const oldModal = document.getElementById('postModal');
  if (oldModal) oldModal.remove();

  const modal = document.createElement('div');
  modal.id = 'postModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;overflow:auto;z-index:9999;padding:20px;';

  const backBtn = document.createElement('button');
  backBtn.textContent = '← Back';
  backBtn.style.cssText = 'margin-bottom:16px;font-size:16px;';
  backBtn.addEventListener('click', () => { history.pushState({}, '', '/'); closeModal(); });
  modal.appendChild(backBtn);

  const h2 = document.createElement('h2');
  h2.textContent = post.title || 'Untitled';
  modal.appendChild(h2);

  const images = [];
  const videoId = post.youtubeId || getYouTubeId(post.link);
  if(videoId) images.push(`https://img.youtube.com/vi/${videoId}/hqdefault.jpg`);
  if(post.image) images.push(fixPath(post.image,'image'));
  if(post.featuredImage) images.push(fixPath(post.featuredImage,'image'));
  [...new Set(images)].forEach(src => {
    const img = document.createElement('img');
    img.src = src; img.alt = post.title; img.style.cssText = 'width:100%;max-width:800px;margin:10px 0;';
    img.onerror = () => handleImageError(img);
    modal.appendChild(img);
  });

  // Full content (cached)
  const contentDiv = document.createElement('div');
  const cacheKey = post.link || post.path || post.content_file || '';
  if(modalContentCache[cacheKey]){
    contentDiv.innerHTML = modalContentCache[cacheKey];
  } else {
    if(post.content_file){
      try{
        const res = await fetch(fixPath(post.content_file,'post'));
        contentDiv.innerHTML = res.ok ? await res.text() : (post.summary||post.excerpt||'');
      } catch {
        contentDiv.textContent = post.summary||post.excerpt||'';
      }
    } else {
      contentDiv.textContent = post.summary||post.excerpt||'';
    }
    modalContentCache[cacheKey] = contentDiv.innerHTML;
  }
  modal.appendChild(contentDiv);

  document.body.appendChild(modal);

  // Push URL state
  const link = post.link || fixPath(post.content_file || post.path, 'post') || '/';
  if(normalizePath(window.location.pathname) !== normalizePath(link)){
    history.pushState({post}, '', link);
  }
}

function closeModal(){ 
  openPost = null; 
  const modal = document.getElementById('postModal'); 
  if(modal) modal.remove(); 
  document.getElementById('posts').style.display='block'; 
}

// --- Render posts ---
function renderPosts(posts){
  const container=document.getElementById('posts'); container.innerHTML = posts.length ? '' : 'No posts yet.';
  posts.sort((a,b)=>new Date(b.date)-new Date(a.date));

  posts.forEach(post=>{
    const div=document.createElement('div'); div.className='post';
    const titleText=post.title?.trim()||'Untitled';
    const link=post.link||fixPath(post.content_file||post.path,'post')||'#';

    const h2=document.createElement('h2');
    const titleLink=document.createElement('a');
    titleLink.href=link; titleLink.textContent=titleText;
    titleLink.addEventListener('click', e=>{ e.preventDefault(); showPostModal(post); });
    h2.appendChild(titleLink); div.appendChild(h2);

    const images=[];
    const videoId=post.youtubeId||getYouTubeId(post.link);
    if(videoId) images.push(`https://img.youtube.com/vi/${videoId}/hqdefault.jpg`);
    if(post.image) images.push(fixPath(post.image,'image'));
    if(post.featuredImage) images.push(fixPath(post.featuredImage,'image'));
    [...new Set(images)].forEach((src,index)=>{
      const img=document.createElement('img'); img.src=src; img.alt=titleText; img.decoding='async'; img.width=500; img.height=200;
      if(index===0){img.loading='eager'; img.setAttribute('fetchpriority','high');} else img.loading='lazy';
      img.onerror=()=>handleImageError(img); div.appendChild(img);
    });

    const p=document.createElement('p'); p.className='post-text';
    const text=(post.summary||post.excerpt||'').trim();
    const maxLength=200; p.textContent=text.length>maxLength?text.slice(0,maxLength)+'… ':text;

    const readMore=makeLink(link,`Read more about "${titleText}"`); readMore.className='read-more';
    readMore.addEventListener('click', e=>{ e.preventDefault(); showPostModal(post); });
    p.appendChild(readMore); div.appendChild(p);

    const d=document.createElement('div'); d.className='date'; d.textContent=post.date?timeAgo(post.date):''; div.appendChild(d);

    container.appendChild(div);
  });
}

// --- JSON Filter ---
document.getElementById('jsonFilter').addEventListener('input', e=>{
  const q=e.target.value.toLowerCase().trim();
  Array.from(document.querySelectorAll('.post')).forEach(node=>{
    const title=node.querySelector('h2')?.innerText.toLowerCase()||'';
    const excerpt=node.querySelector('p')?.innerText.toLowerCase()||'';
    node.style.display = !q || title.includes(q) || excerpt.includes(q) ? 'block':'none';
  });
});

// --- Initial load + modal auto-open ---
(async()=>{
  const posts = await loadPosts();
  renderPosts(posts);

  const initialPost = getPostByPath(window.location.pathname, posts);
  if(initialPost) showPostModal(initialPost);
})();

// --- Popstate for back/forward ---
window.addEventListener('popstate', ()=>{
  const posts = document.querySelectorAll('.post');
  const post = getPostByPath(window.location.pathname, posts);
  if(post) showPostModal(post); else closeModal();
});

// --- PWA Service Worker + Push Subscription on First Click ---
if('serviceWorker' in navigator && 'PushManager' in window){
  let swRegistration=null;
  window.addEventListener('load', async()=>{
    try{ swRegistration=await navigator.serviceWorker.register('/sw.js'); console.log('Service Worker registered:', swRegistration.scope);}
    catch(err){ console.error('Service Worker registration failed:',err);}
  });

  async function subscribeUser(){
    try{
      const reg=swRegistration||await navigator.serviceWorker.ready;
      const permission=await Notification.requestPermission();
      if(permission!=='granted'){ console.log('Notifications blocked'); return; }
      const vapidRes=await fetch('/vapidPublicKey');
      const { publicKey }=await vapidRes.json();
      const subscription=await reg.pushManager.getSubscription()||await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey:urlBase64ToUint8Array(publicKey)});
      await fetch('/api/save-subscription',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(subscription)});
      console.log('Push subscription saved!',subscription);
    }catch(err){ console.error('Push subscription failed:',err);}
  }

  function handleFirstClick(){ window.removeEventListener('click',handleFirstClick,{passive:true}); subscribeUser(); }
  window.addEventListener('click',handleFirstClick,{passive:true});
}

// --- VAPID helper ---
function urlBase64ToUint8Array(base64String){ const padding='='.repeat((4-(base64String.length%4))%4); const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/'); const rawData=window.atob(base64); return Uint8Array.from([...rawData].map(c=>c.charCodeAt(0))); }
</script>
</body>
</html>
