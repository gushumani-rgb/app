<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anywhere Income – Work from Anywhere & Earn Online in 2025</title>
<link rel="manifest" href="/manifest.json">
<link rel="alternate" type="application/json" href="/index.json">
<style>
  /* Your CSS styling from before */
  body {margin:0;font-family:Arial,sans-serif;background:#f7f8fb;color:#4a5568;}
  .wrap {max-width:800px;margin:36px auto;padding:20px;}
  h1 {text-align:center;color:#0b63b8;margin-bottom:24px;}
  .search {width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefb;margin-bottom:12px;}
  .post {background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 6px 18px rgba(11,63,120,0.06);}
  .post h2 {margin:0 0 6px;font-size:16px;}
  .post img {width:100%;height:auto;aspect-ratio:5/2;min-height:160px;border-radius:8px;margin-bottom:8px;display:block;object-fit:cover;}
  .post-text {font-size:14px;margin-bottom:8px;min-height:80px;}
  .read-more {display:inline-block;margin-top:6px;color:#0b63b8;font-size:14px;text-decoration:none;}
  .date {font-size:12px;color:#1f2937;margin-top:8px;}
  .post-skeleton {background:#eceff6;border-radius:12px;height:200px;margin-bottom:14px;animation:pulse 1.2s infinite;}
  @keyframes pulse {0% {opacity:1;}50% {opacity:0.4;}100% {opacity:1;}}
  #posts {min-height:500px;}
</style>
</head>
<body>
<header class="wrap">
  <h1 id="site-title">Anywhere Income</h1>
</header>

<main class="wrap">
  <input id="jsonFilter" class="search" placeholder="Filter posts...">
  <div id="posts">
    <div class="post-skeleton"></div>
    <div class="post-skeleton"></div>
    <div class="post-skeleton"></div>
  </div>
</main>

<footer class="wrap" style="text-align:center;padding:12px;color:#4a5568;">
  <small>&copy; <span id="year"></span> Anywhere Income</small>
</footer>

<script>
// -------------------- Year & Helpers --------------------
document.getElementById('year').textContent = new Date().getFullYear();

// (Helper functions: fixPath, timeAgo, makeLink, handleImageError, getYouTubeId, loadPosts, renderPosts)
// Use the same helpers as in previous snippet

// -------------------- Filter --------------------
document.getElementById('jsonFilter').addEventListener('input', e=>{
  const q=e.target.value.toLowerCase().trim();
  Array.from(document.querySelectorAll('.post')).forEach(node=>{
    const title=node.querySelector('h2')?.innerText.toLowerCase()||'';
    const excerpt=node.querySelector('p')?.innerText.toLowerCase()||'';
    node.style.display=!q||title.includes(q)||excerpt.includes(q)?'':'none';
  });
});

// -------------------- Load posts --------------------
(async()=>{
  const posts=await loadPosts();
  renderPosts(posts);
  setInterval(async()=>{ const p=await loadPosts(); renderPosts(p); },30000);
})();

// -------------------- Browser Install Prompt --------------------
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  console.log('Browser install prompt ready — browser handles display automatically');
});

// -------------------- PWA Push Subscription --------------------
function isPWA(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true; }

async function subscribePush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
  try {
    const reg = await navigator.serviceWorker.register('/sw.js');
    console.log('Service Worker registered:', reg.scope);

    if (Notification.permission !== 'granted') {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') return console.log('Notifications denied');
    }

    const vapidRes = await fetch('/vapidPublicKey');
    const { publicKey } = await vapidRes.json();

    let subscription = await reg.pushManager.getSubscription();
    if (!subscription) {
      subscription = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });
    }

    await fetch('/api/save-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(subscription)
    });

    console.log('Push notifications enabled for PWA', subscription);
  } catch (err) {
    console.error('Push subscription failed', err);
  }
}

window.addEventListener('load', ()=>{ if(isPWA()) subscribePush(); });

function urlBase64ToUint8Array(base64String){
  const padding='='.repeat((4-(base64String.length%4))%4);
  const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/');
  const rawData=window.atob(base64);
  return Uint8Array.from([...rawData].map(c=>c.charCodeAt(0)));
}
</script>
</body>
</html>
