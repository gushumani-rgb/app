name: Build index & Service Worker

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  POSTS_DIR: posts
  INDEX_PATH: index.json
  SW_PATH: sw.js

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Build index.json
        run: |
          import os, json, re

          POSTS_DIR = os.getenv("POSTS_DIR")
          INDEX_PATH = os.getenv("INDEX_PATH")

          posts = []
          yt_regex = re.compile(r'https:\/\/www\.youtube\.com\/embed\/([A-Za-z0-9_-]+)')

          for filename in os.listdir(POSTS_DIR):
            if not filename.endswith(".html"):
              continue

            full_path = os.path.join(POSTS_DIR, filename)
            content = open(full_path, "r", encoding="utf-8").read()

            # Extract title
            title_match = re.search(r'<h1[^>]*>(.*?)<\/h1>', content, re.IGNORECASE | re.DOTALL)
            title = title_match.group(1).strip() if title_match else filename

            # Extract YouTube ID
            yt_match = yt_regex.search(content)
            if yt_match:
              video_id = yt_match.group(1)
              featured = f"https://img.youtube.com/vi/{video_id}/hqdefault.jpg"
            else:
              # Try to find first <img> src
              img_match = re.search(r'<img[^>]+src="([^"]+)"', content)
              featured = img_match.group(1) if img_match else ""

            posts.append({
              "title": title,
              "slug": filename.replace(".html", ""),
              "url": f"/posts/{filename}",
              "featuredImage": featured
            })

          posts.sort(key=lambda x: x["title"].lower())

          with open(INDEX_PATH, "w", encoding="utf-8") as f:
            json.dump(posts, f, indent=2)

      - name: Build service worker
        run: |
          SW_PATH = os.getenv("SW_PATH")
          POSTS_DIR = os.getenv("POSTS_DIR")

          # Collect post paths
          post_files = [f"/posts/{f}" for f in os.listdir(POSTS_DIR) if f.endswith(".html")]

          sw = f"""
self.addEventListener('install', event => {{
  event.waitUntil(
    caches.open('v1').then(cache => {{
      return cache.addAll([
        '/',
        '/index.json',
        {",".join(['"%s"' % p for p in post_files])}
      ]);
    }})
  );
}});

self.addEventListener('fetch', event => {{
  event.respondWith(
    caches.match(event.request).then(resp => {{
      return resp || fetch(event.request);
    }})
  );
}});
"""

          with open(SW_PATH, "w", encoding="utf-8") as f:
            f.write(sw)

      - name: Commit & Push results
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git add index.json sw.js
          git commit -m "Auto-build index.json and sw.js" || echo "No changes"
          git push
